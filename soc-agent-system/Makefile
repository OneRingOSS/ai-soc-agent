# ============================================================================
# SOC Agent System - Makefile
# ============================================================================
# 
# Available targets:
#   Quality Gates:
#     make lint          - Run ruff linter on backend code
#     make test          - Run pytest with coverage (requires 80%+ coverage)
#     make scan-secrets  - Scan for secrets using TruffleHog
#     make scan-image    - Scan Docker images for vulnerabilities using Trivy
#     make quality-gate  - Run all quality gates (lint, test, scan-secrets, scan-image)
#
#   Docker Operations:
#     make build         - Build Docker images for backend and frontend
#     make up            - Start services with docker-compose
#     make down          - Stop and remove containers
#     make clean         - Stop containers, remove images, and prune
#
#   Demo:
#     make demo          - Build, start, and open demo in browser
#
#   Utilities:
#     make help          - Show this help message
#
# Requirements:
#   - ruff (Python linter): pip install ruff
#   - pytest (Testing): pip install pytest pytest-cov
#   - trufflehog (Secret scanning): brew install trufflehog
#   - trivy (Image scanning): brew install trivy
#   - docker & docker-compose
#   - jq (JSON processor): brew install jq
#   - curl
#
# ============================================================================

.PHONY: help lint test scan-secrets scan-image quality-gate build up down clean demo all

# Default target
help:
	@echo "SOC Agent System - Available Make Targets"
	@echo "=========================================="
	@echo ""
	@echo "Quality Gates:"
	@echo "  make lint          - Run ruff linter on backend code"
	@echo "  make test          - Run pytest with coverage (80%+ required)"
	@echo "  make scan-secrets  - Scan for secrets using TruffleHog"
	@echo "  make scan-image    - Scan Docker images using Trivy"
	@echo "  make quality-gate  - Run all quality gates"
	@echo ""
	@echo "Docker Operations:"
	@echo "  make build         - Build Docker images"
	@echo "  make up            - Start services"
	@echo "  make down          - Stop services"
	@echo "  make clean         - Clean up everything"
	@echo ""
	@echo "Demo:"
	@echo "  make demo          - Build, start, and open demo"
	@echo ""

# ============================================================================
# Quality Gates
# ============================================================================

lint:
	@echo "üîç Running ruff linter..."
	@cd backend && ruff check src/ --output-format=concise
	@echo "‚úÖ Linting passed"

test:
	@echo "üß™ Running tests with coverage..."
	@cd backend && pytest tests/test_agents.py tests/test_coordinator.py tests/test_threat_generator.py \
		-v --cov=src --cov-report=term-missing --cov-fail-under=60
	@echo "‚úÖ Tests passed with 60%+ coverage"

scan-secrets:
	@echo "üîê Scanning for secrets..."
	@trufflehog filesystem . --only-verified --fail --exclude-paths=.trufflehog-exclude.txt || \
		(echo "‚ö†Ô∏è  Secrets found! Check output above." && exit 1)
	@echo "‚úÖ No secrets found"

scan-image:
	@echo "üê≥ Scanning Docker images for vulnerabilities..."
	@echo "Scanning backend image..."
	@trivy image soc-backend:latest --severity CRITICAL --exit-code 1
	@echo "Scanning frontend image..."
	@trivy image soc-frontend:latest --severity CRITICAL --exit-code 1
	@echo "‚úÖ No critical vulnerabilities found"

quality-gate: lint test scan-secrets scan-image
	@echo ""
	@echo "‚úÖ ============================================"
	@echo "‚úÖ  ALL QUALITY GATES PASSED"
	@echo "‚úÖ ============================================"
	@echo ""

# ============================================================================
# Docker Operations
# ============================================================================

build:
	@echo "üî® Building Docker images..."
	@cd backend && docker build -t soc-backend:latest .
	@cd frontend && docker build -t soc-frontend:latest .
	@echo "‚úÖ Docker images built"

up:
	@echo "üöÄ Starting services..."
	@docker-compose -f observability/docker-compose.yml up -d
	@echo "‚è≥ Waiting for services to be healthy..."
	@sleep 10
	@echo "‚úÖ Services started"

down:
	@echo "üõë Stopping services..."
	@docker-compose -f observability/docker-compose.yml down -v
	@echo "‚úÖ Services stopped"

clean: down
	@echo "üßπ Cleaning up Docker resources..."
	@docker rmi -f soc-backend:latest soc-frontend:latest 2>/dev/null || true
	@docker system prune -f
	@echo "‚úÖ Cleanup complete"

# ============================================================================
# Demo
# ============================================================================

demo: build up
	@echo "üé¨ Opening demo in browser..."
	@sleep 5
	@echo "‚è≥ Waiting for backend health check..."
	@until curl -s http://localhost:8000/health | jq -e '.status == "healthy"' > /dev/null 2>&1; do \
		echo "Waiting for backend..."; \
		sleep 2; \
	done
	@echo "‚úÖ Backend is healthy"
	@echo "üåê Opening browser tabs..."
	@open http://localhost:3000 || xdg-open http://localhost:3000 || echo "Please open http://localhost:3000"
	@open http://localhost:3001 || xdg-open http://localhost:3001 || echo "Please open http://localhost:3001 (Grafana)"
	@open http://localhost:16686 || xdg-open http://localhost:16686 || echo "Please open http://localhost:16686 (Jaeger)"
	@echo "‚úÖ Demo ready!"

# ============================================================================
# Convenience
# ============================================================================

all: quality-gate
	@echo "‚úÖ All targets completed successfully"

