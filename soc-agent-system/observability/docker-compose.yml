# =============================================================================
# SOC Agent System — Observability Stack
# =============================================================================
# Extracted codebase values:
#   Service name:       soc-agent-system
#   OTLP endpoint:      http://localhost:4317 (gRPC)
#   Backend port:       8000
#   Metrics endpoint:   /metrics
#   JSON log fields:    timestamp, level, logger_name, module, trace_id, span_id, message
#
# Custom Prometheus Metrics:
#   - soc_threats_processed_total       (Counter,   labels: severity, threat_type)
#   - soc_agent_duration_seconds        (Histogram, labels: agent_name)
#   - soc_fp_score                      (Histogram)
#   - soc_threat_processing_duration_seconds (Histogram, labels: phase)
#   - soc_active_websocket_connections  (Gauge)
#   - soc_threats_requiring_review      (Gauge)
#
# Usage:
#   cd soc-agent-system/observability
#   docker compose up -d
#
# UIs:
#   Jaeger:     http://localhost:16686
#   Prometheus: http://localhost:9090
#   Grafana:    http://localhost:3000  (admin / admin)
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Jaeger — Distributed tracing backend (all-in-one)
  # Receives OTLP/gRPC on port 4317, UI on 16686
  # ---------------------------------------------------------------------------
  jaeger:
    image: jaegertracing/all-in-one:1.54
    container_name: soc-jaeger
    restart: unless-stopped
    ports:
      - "16686:16686"   # Jaeger UI
      - "4317:4317"     # OTLP gRPC receiver
      - "4318:4318"     # OTLP HTTP receiver
    environment:
      - COLLECTOR_OTLP_ENABLED=true
    networks:
      - observability

  # ---------------------------------------------------------------------------
  # Prometheus — Metrics collection and storage
  # Scrapes backend at host.docker.internal:8000/metrics every 15s
  # Data retained for 15 days
  # ---------------------------------------------------------------------------
  prometheus:
    image: prom/prometheus:v2.50.1
    container_name: soc-prometheus
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--storage.tsdb.retention.time=15d"
      - "--web.enable-lifecycle"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - observability

  # ---------------------------------------------------------------------------
  # Loki — Log aggregation backend
  # Receives logs from Promtail, queryable via Grafana
  # ---------------------------------------------------------------------------
  loki:
    image: grafana/loki:2.9.4
    container_name: soc-loki
    restart: unless-stopped
    ports:
      - "3100:3100"
    volumes:
      - ./loki/loki-config.yml:/etc/loki/local-config.yaml:ro
      - loki_data:/loki
    command: -config.file=/etc/loki/local-config.yaml
    networks:
      - observability

  # ---------------------------------------------------------------------------
  # Promtail — Log collector
  # Tails JSON logs from observability/logs/ and ships to Loki
  # Parses: timestamp, level, logger_name, module, trace_id, span_id, message
  # ---------------------------------------------------------------------------
  promtail:
    image: grafana/promtail:2.9.4
    container_name: soc-promtail
    restart: unless-stopped
    volumes:
      - ./promtail/promtail-config.yml:/etc/promtail/config.yml:ro
      - ./logs:/var/log/soc-agent:ro
    command: -config.file=/etc/promtail/config.yml
    depends_on:
      - loki
    networks:
      - observability

  # ---------------------------------------------------------------------------
  # Grafana — Dashboards and visualization
  # Pre-provisioned with Prometheus, Loki, and Jaeger datasources
  # Default credentials: admin / admin
  # ---------------------------------------------------------------------------
  grafana:
    image: grafana/grafana:10.3.3
    container_name: soc-grafana
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - ./grafana/dashboards:/var/lib/grafana/dashboards:ro
      - grafana_data:/var/lib/grafana
    depends_on:
      - prometheus
      - loki
      - jaeger
    networks:
      - observability

# =============================================================================
# Persistent volumes — survive container restarts
# =============================================================================
volumes:
  prometheus_data:
    driver: local
  loki_data:
    driver: local
  grafana_data:
    driver: local

# =============================================================================
# Network — all services communicate on the 'observability' bridge network
# =============================================================================
networks:
  observability:
    name: observability
    driver: bridge

